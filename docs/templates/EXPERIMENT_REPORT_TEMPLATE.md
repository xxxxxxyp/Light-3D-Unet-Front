# FL-70% Lightweight 3D U-Net Experiment Report Template

**实验报告模板 - FL-70% 轻量级 3D U-Net 前端召回器**

---

## 1. 执行摘要 (Executive Summary)

### 1.1 项目概述
- **项目名称**: FL-70% 轻量级 3D U-Net 前端召回器
- **目标**: 构建并验证用于 PET-only 病灶候选检测的轻量级 3D U-Net
- **数据集**: Follicular Lymphoma (FL), 123 例
- **处理路径**: Path B (保留 4×4×4mm spacing)

### 1.2 关键结果
- **验证集 Lesion-wise Recall**: [填写] (目标: ≥ 80%)
- **验证集 Voxel-wise DSC**: [填写]
- **FP per case**: [填写]
- **模型参数量**: 217,228
- **最佳模型 Epoch**: [填写]

### 1.3 主要发现
[填写关键发现和观察]

---

## 2. 数据准备说明 (Data Preparation)

### 2.1 数据划分

| 分组 | 案例数 | 比例 | 用途 |
|------|--------|------|------|
| 训练集 | 86 | 70% | 模型训练 |
| 验证集 | 18-19 | 15% | 模型选择和超参调优 |
| 测试集 | 18-19 | 15% | 黑盒测试（未使用） |

- **随机种子**: 42
- **划分时间**: [从 split_manifest.json 填写]

### 2.2 预处理流程 (Path B)

#### 强度处理
- **裁剪百分位**: 0.5% - 99.5%
- **归一化范围**: [0, 1]

**示例案例 (FL_001)**:
```json
{
  "clip_values": {
    "min": [填写],
    "max": [填写]
  },
  "normalization_range": [0, 1]
}
```

#### 空间处理
- **原始 spacing**: [4.0, 4.0, 4.0] mm
- **目标 spacing**: [4.0, 4.0, 4.0] mm (无重采样)
- **图像尺寸**: 144×144×Z (Z 可变)

#### Patch 配置
- **Patch 大小**: 48×48×48 voxels
- **物理覆盖**: ~192×192×192 mm³ (at 4mm spacing)

### 2.3 连通域体积阈值

| 用途 | 体积阈值 (cc) | 体素阈值 | 计算公式 |
|------|---------------|----------|----------|
| 训练样本过滤 | 0.1 | [填写] | ceil(0.1 / voxel_volume_cc) |
| 候选生成 | 0.5 | [填写] | ceil(0.5 / voxel_volume_cc) |

**体素体积计算**:
- Voxel volume = 4.0 × 4.0 × 4.0 = 64 mm³ = 0.064 cc
- 0.1 cc threshold = ceil(0.1 / 0.064) = [填写] voxels
- 0.5 cc threshold = ceil(0.5 / 0.064) = [填写] voxels

### 2.4 BBox 扩张参数
- **物理扩张**: 10 mm
- **体素扩张**: ceil(10 / 4) = 3 voxels

---

## 3. 模型架构 (Model Architecture)

### 3.1 网络结构

| 层级 | 输入通道 | 输出通道 | 操作 |
|------|----------|----------|------|
| 初始层 | 1 | 16 | ResBlock |
| 下采样1 | 16 | 32 | MaxPool + ResBlock |
| 下采样2 | 32 | 64 | MaxPool + ResBlock |
| 下采样3 | 64 | 128 | MaxPool + ResBlock |
| 瓶颈层 | 128 | 128 | ResBlock |
| 上采样1 | 128 | 64 | ConvTranspose + Skip + ResBlock |
| 上采样2 | 64 | 32 | ConvTranspose + Skip + ResBlock |
| 上采样3 | 32 | 16 | ConvTranspose + Skip + ResBlock |
| 输出层 | 16 | 1 | Conv1×1 + Sigmoid |

### 3.2 关键特性
- **卷积类型**: 深度可分离卷积 + 分组卷积
- **归一化**: InstanceNorm3d
- **激活函数**: LeakyReLU (slope=0.01)
- **残差连接**: 是
- **Dropout**: p=0.1
- **总参数**: 217,228 (全部可训练)

---

## 4. 训练配置 (Training Configuration)

### 4.1 损失函数
- **主要损失**: Focal Tversky Loss
  - α (FN weight): 0.7
  - β (FP weight): 0.3
  - γ (focal): 0.75
- **是否使用组合损失**: [是/否]
  - 如是，FTL weight: [填写], BCE weight: [填写]
  - 原因: [填写]

### 4.2 优化器配置
- **优化器**: AdamW
- **初始学习率**: 1e-4
- **Weight decay**: 1e-5
- **调度器**: [CosineAnnealingLR / ReduceLROnPlateau]
- **Warmup epochs**: 5

### 4.3 训练超参数
- **总 Epochs**: 200
- **实际训练 Epochs**: [填写]
- **Batch size**: [2/4]
- **早停 Patience**: 20 epochs
- **是否触发早停**: [是/否], Epoch: [填写]

### 4.4 数据增强
- ✅ 随机翻转 (prob=0.5)
- ✅ 随机旋转 ±15° (prob=0.5)
- ✅ 随机缩放 ±10% (prob=0.3)
- ✅ 强度扰动 ±10% (prob=0.5)
- ✅ 高斯噪声 σ=0.01 (prob=0.3)

### 4.5 Class-Balanced Sampling
- **病灶 patch 比例**: ≥50%
- **最少病灶 patches/batch**: ≥1

---

## 5. 训练过程与结果 (Training Results)

### 5.1 训练曲线

[插入训练曲线图]
- Loss (train vs. val)
- Recall (validation)
- DSC (validation)

### 5.2 学习率变化

[插入学习率曲线]

### 5.3 训练统计

| 指标 | 最佳值 | Epoch | 最终值 |
|------|--------|-------|--------|
| Train Loss | [填写] | [填写] | [填写] |
| Val Loss | [填写] | [填写] | [填写] |
| Val Recall | [填写] | [填写] | [填写] |
| Val Precision | [填写] | [填写] | [填写] |
| Val DSC | [填写] | [填写] | [填写] |

### 5.4 模型选择
- **选择标准**: 验证集最高 Lesion-wise Recall
- **最佳模型 Epoch**: [填写]
- **最佳 Recall**: [填写]
- **对应 DSC**: [填写]
- **保存路径**: `models/best_model.pth`

---

## 6. 验证结果 (Validation Results)

### 6.1 阈值敏感性分析

| Threshold | Recall | Precision | F1 | DSC | FP/case |
|-----------|--------|-----------|-----|-----|---------|
| 0.1 | [填写] | [填写] | [填写] | [填写] | [填写] |
| 0.2 | [填写] | [填写] | [填写] | [填写] | [填写] |
| 0.3* | [填写] | [填写] | [填写] | [填写] | [填写] |
| 0.4 | [填写] | [填写] | [填写] | [填写] | [填写] |
| 0.5 | [填写] | [填写] | [填写] | [填写] | [填写] |
| 0.6 | [填写] | [填写] | [填写] | [填写] | [填写] |
| 0.7 | [填写] | [填写] | [填写] | [填写] | [填写] |

*默认阈值

**最佳阈值**:
- Recall 最高: threshold=[填写], recall=[填写]
- F1 最高: threshold=[填写], f1=[填写]

### 6.2 混淆矩阵 (Lesion-level)

| | 预测阳性 | 预测阴性 |
|---------|----------|----------|
| **实际阳性** | TP=[填写] | FN=[填写] |
| **实际阴性** | FP=[填写] | TN=[填写] |

### 6.3 每例结果统计

| 统计量 | Recall | Precision | DSC | FP/case |
|--------|--------|-----------|-----|---------|
| 均值 | [填写] | [填写] | [填写] | [填写] |
| 中位数 | [填写] | [填写] | [填写] | [填写] |
| 标准差 | [填写] | [填写] | [填写] | [填写] |
| 最小值 | [填写] | [填写] | [填写] | [填写] |
| 最大值 | [填写] | [填写] | [填写] | [填写] |

---

## 7. 案例分析 (Case Analysis)

### 7.1 成功案例

**案例 ID**: [填写]
- **Recall**: [填写]
- **Precision**: [填写]
- **候选数**: [填写]
- **成功原因**: [分析]

[可选：插入可视化图像]

### 7.2 失败案例

**案例 ID**: [填写]
- **Recall**: [填写]
- **Precision**: [填写]
- **漏检病灶**: [填写]
- **失败原因**: [分析]

**案例 ID**: [填写]
- **Recall**: [填写]
- **FP 数**: [填写]
- **失败原因**: [分析]

### 7.3 典型误检分析
1. **小病灶漏检**: [分析和数量]
2. **假阳性来源**: [分析，如正常器官摄取]
3. **边界不准确**: [分析]

---

## 8. 遇到的问题与解决方案 (Issues & Solutions)

### 8.1 数据准备阶段

| 问题 | 解决方案 | 状态 |
|------|----------|------|
| [填写] | [填写] | [已解决/未解决] |

### 8.2 训练阶段

| 问题 | 解决方案 | 状态 |
|------|----------|------|
| [填写] | [填写] | [已解决/未解决] |

### 8.3 推理与评估阶段

| 问题 | 解决方案 | 状态 |
|------|----------|------|
| [填写] | [填写] | [已解决/未解决] |

---

## 9. 性能评估 (Performance Assessment)

### 9.1 目标达成情况

| 目标 | 目标值 | 实际值 | 达成？ |
|------|--------|--------|--------|
| Lesion-wise Recall | ≥ 80% | [填写] | [是/否] |
| 可复现性 | 完整记录 | [是/否] | [是/否] |
| 数据合规 | 4×4×4mm | [是/否] | [是/否] |

### 9.2 与预期的对比

[分析结果是否符合预期，如果不符合，分析原因]

---

## 10. 改进建议 (Improvement Suggestions)

### 10.1 如果 Recall < 80%

**建议 1**: [具体建议]
- **理由**: [填写]
- **预期改进**: [填写]
- **实施难度**: [低/中/高]

**建议 2**: [具体建议]
- **理由**: [填写]
- **预期改进**: [填写]
- **实施难度**: [低/中/高]

**建议 3**: [具体建议]
- **理由**: [填写]
- **预期改进**: [填写]
- **实施难度**: [低/中/高]

### 10.2 如果 Recall ≥ 80%

**进一步优化方向**:
1. [填写]
2. [填写]
3. [填写]

---

## 11. 可复现性检查清单 (Reproducibility Checklist)

- [ ] Random seed 已设置 (seed=42)
- [ ] 环境信息已保存 (`pip freeze > environment.txt`)
- [ ] Git commit hash 已记录
- [ ] 配置文件版本已保存
- [ ] 训练日志完整
- [ ] Best model checkpoint 已保存
- [ ] 所有中间文件已保存
- [ ] Metadata.json 完整

---

## 12. 交付物确认 (Deliverables Checklist)

### Milestone 1: 数据准备
- [ ] `data/splits/` with train/val/test lists
- [ ] `data/split_manifest.json`
- [ ] `data/processed/` with metadata
- [ ] 预处理验证报告

### Milestone 2: 训练
- [ ] 训练日志
- [ ] 多个 checkpoint
- [ ] TensorBoard 记录

### Milestone 3: 最终模型
- [ ] `models/best_model.pth`
- [ ] 验证报告
- [ ] 训练历史

### Milestone 4: 推理与报告
- [ ] 概率图 (NIfTI)
- [ ] BBox JSON
- [ ] `inference/metrics.csv`
- [ ] 本实验报告

---

## 13. 附录 (Appendix)

### 13.1 环境信息
```
Python版本: [填写]
PyTorch版本: [填写]
CUDA版本: [填写]
GPU型号: [填写]
操作系统: [填写]
```

### 13.2 完整配置文件
[粘贴 `configs/unet_fl70.yaml` 内容]

### 13.3 关键代码片段
[如有重要修改，记录在此]

### 13.4 参考文献
[如有参考论文或资源，列在此处]

---

**报告完成日期**: [填写]
**报告作者**: [填写]
**项目路径**: `/path/to/Light-3D-Unet-Front`

---

**注意事项**:
1. 所有 [填写] 标记需要替换为实际数据
2. 所有图表需要从实验结果中生成并插入
3. 分析部分需要提供详细的观察和解释
4. 建议部分必须具体且可行
